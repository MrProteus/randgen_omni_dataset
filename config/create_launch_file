#! /usr/bin/env python

import argparse
import math
import random
import rospkg
import xml.etree.cElementTree as ET
from xml.etree import ElementTree
from randgen_omni_dataset.robot import HEIGHT
from xml.dom import minidom

THETA_RANGE = (-math.pi, math.pi)
PKG = 'randgen_omni_dataset'
NUM_PARTICLES_FOR_ONE_ROBOT = 50


def prettify(elem):
    """Return a pretty-printed XML string for the Element.
    """
    rough_string = ElementTree.tostring(elem, 'utf-8')
    reparsed = minidom.parseString(rough_string)
    return reparsed.toprettyxml(indent="  ")


def dist(x1, y1, x2, y2):
    return math.sqrt(math.pow(x2-x1, 2) + math.pow(y2-y1, 2))


class Robot:
    def __init__(self, r_id, x, y, theta, radius):
        self.id = r_id
        self.name = 'omni' + str(self.id)
        self.x = x
        self.y = y
        self.theta = theta
        self.radius = radius

    def check_collisions(self, r_list):
        for robot in r_list:
            if dist(self.x, robot.x, self.y, robot.y) < 2*self.radius:
                # collision detected with robot x
                return robot.id

        # no collisions detected
        return -1

    def get_dict(self):
        return {'x': self.x, 'y': self.y, 'theta': self.theta}


if __name__ == '__main__':

    # parse arguments from command line
    # need number of robots, world limits, filename, robot radius
    parser = argparse.ArgumentParser(description='Process arguments to create launch file')
    parser.add_argument('N', type=int, help='Number of robots desired')
    parser.add_argument('-R', '--radius', type=float, default=0.5, help='Robot radius to be considered')
    parser.add_argument('-f', '--file', type=str, default='new.launch', help='Desired filename to be placed in launch directory')
    parser.add_argument('-l', '--left', type=float, default=-0.0, help='Left limit to place robots')
    parser.add_argument('-r', '--right', type=float, default=10.0, help='Right limit to place robots')
    parser.add_argument('-u', '--up', type=float, default=5.0, help='Up limit to place robots')
    parser.add_argument('-d', '--down', type=float, default=-5.0, help='Down limit to place robots')
    args = parser.parse_args()

    # create robots
    robot_list = []
    for n in range(1, args.N+1):
        print 'Creating robot %d' % n

        robot = Robot(n, random.uniform(args.left, args.right), random.uniform(args.down, args.up),
                      random.uniform(*THETA_RANGE), args.radius)

        tries = 0
        while robot.check_collisions(robot_list) is not -1:
            tries += 1
            col = robot.check_collisions(robot_list)
            print 'Try #%d - detected collision with robot %d at {%f , %f}' % (tries, col, robot_list[col-1].x, robot_list[col-1].y)
            robot.x = random.uniform(args.left, args.right)
            robot.y = random.uniform(args.down, args.up)
            print 'Trying position {%f, %f}' % (robot.x, robot.y)

        # no longer colliding, insert into list and print location
        robot_list.append(robot)
        print 'Robot %d created at {%f,%f,%f}' % (n, robot.x, robot.y, robot.theta)

    # robots have been assigned positions
    # generate a ball anywhere (x, y, z)
    ball = {'x': random.uniform(args.left, args.right),
            'y': random.uniform(args.down, args.up),
            'z': random.uniform(0.0, 3.0)}

    # use rospkg to find the directory of this package
    rospack = rospkg.RosPack()
    path = rospack.get_path('randgen_omni_dataset')
    path += '/launch/' + args.file

    # now write the launch file
    launch = ET.Element("launch")

    # parameter PLAYING_ROBOTS
    ET.SubElement(launch, 'rosparam', param='PLAYING_ROBOTS').text = str([1]*args.N)

    # include the world launch file
    ET.SubElement(launch, 'include', file='$(find randgen_omni_dataset)/launch/world.launch')

    # ball node
    ball_el = ET.SubElement(launch, 'node', name='ball', pkg=PKG, type='ball')
    ET.SubElement(ball_el, 'rosparam', param='initial_pose').text = str(ball)
    ET.SubElement(ball_el, 'param', name='freq_pub', value='100')

    # for all robots
    for robot in robot_list:
        # robot node
        node_robot = ET.SubElement(launch, 'node', name=robot.name, pkg=PKG, type='robot', output='screen')
        ET.SubElement(node_robot, 'rosparam', param='initial_pose').text = str(robot.get_dict())

        # robot odometry node
        node_odometry = ET.SubElement(launch, 'node', name=robot.name+'_odometry', pkg=PKG, type='odometry', output='screen')
        ET.SubElement(node_odometry, 'param', name='topic', value='/'+robot.name+'/genOdometry')

    # custom msg node
    ET.SubElement(launch, 'node', name='omni_custom_msg', pkg=PKG, type='omni_custom', output='screen')

    # pretty print the tree to the file in the path variable
    with open(path, 'w+') as f:
        f.write(prettify(launch))

    # ---------------------------------- PFUCLT ------------------------------------ #
    # now generate a suitable launch file for the pfuclt algorithm

    launch = ET.Element('launch')

    # general parameters to be modified
    ET.SubElement(launch, 'param', name='use_sim_time', value='true')
    ET.SubElement(launch, 'arg', name='path', default='/home/$(optenv USER gsl)/datasets/omni_sim')
    ET.SubElement(launch, 'arg', name='debug', default='false')
    ET.SubElement(launch, 'arg', name='publish', default='true')
    ET.SubElement(launch, 'arg', name='rate', default='1.0')

    # the rosbag node
    str_args = '--quiet --clock --rate=$(arg rate) $(arg path)/omni_simulated.bag'
    ET.SubElement(launch, 'node', pkg='rosbag', type='play', name='player', output='screen', args=str_args)

    # the performer node
    str_alpha_values = '0.015, 0.1, 0.5, 0.001'
    node_pfuclt = ET.SubElement(launch, 'node', name='performer',
                                pkg='pfuclt_omni_dataset', type='pfuclt_omni_dataset', output='screen',
                                args='--debug $(arg debug) --publish $(arg publish)')
    ET.SubElement(node_pfuclt, 'param', name='percentage_to_keep', value='50')
    ET.SubElement(node_pfuclt, 'param', name='velocity_estimator_stack_size', value='15')
    ET.SubElement(node_pfuclt, 'param', name='predict_model_stddev', value='25.0')
    ET.SubElement(node_pfuclt, 'param', name='particles', value=str(args.N * NUM_PARTICLES_FOR_ONE_ROBOT))
    for robot in robot_list:
        ET.SubElement(node_pfuclt, 'param', name=robot.name.upper() + '_alpha', value=str_alpha_values)
    ET.SubElement(node_pfuclt, 'remap', {'from': '/pfuclt_orangeBallState', 'to': '/estimatedOrangeBallState'})
    ET.SubElement(node_pfuclt, 'remap', {'from': '/pfuclt_omni_poses', 'to': '/estimated_omni_poses'})
    ET.SubElement(node_pfuclt, 'remap', {'to': '/gtData', 'from': '/gtData_4robotExp'})

    # other parameters
    ET.SubElement(launch, 'rosparam', param='PLAYING_ROBOTS').text = str([1] * args.N)
    ET.SubElement(launch, 'param', name='MAX_ROBOTS', value=str(args.N))
    ET.SubElement(launch, 'param', name='ROB_HT', value=str(HEIGHT))
    ET.SubElement(launch, 'param', name='MY_ID', value='1')
    ET.SubElement(launch, 'param', name='NUM_TARGETS', value='1')
    ET.SubElement(launch, 'param', name='LANDMARK_COV/K1', value='2.0')
    ET.SubElement(launch, 'param', name='LANDMARK_COV/K2', value='0.5')
    ET.SubElement(launch, 'param', name='LANDMARK_COV/K3', value='0.2')
    ET.SubElement(launch, 'param', name='LANDMARK_COV/K4', value='0.5')
    ET.SubElement(launch, 'param', name='LANDMARK_COV/K5', value='0.5')
    ET.SubElement(launch, 'param', name='NUM_LANDMARKS', value='10')
    ET.SubElement(launch, 'param', name='LANDMARKS_CONFIG', value='$(find pfuclt_omni_dataset)/config/landmarks.csv')
    ET.SubElement(launch, 'param', name='USE_CUSTOM_VALUES', value='false')

    # robot initial poses
    str_pos_init = '['
    for robot in robot_list:
        str_pos_init += str(robot.x) + ', ' + str(robot.y) + ', ' + str(robot.theta) + ', '
    str_pos_init = str_pos_init[:len(str_pos_init)-2]  # remove last comma and whitespace
    str_pos_init += ']'
    ET.SubElement(launch, 'rosparam', param='POS_INIT').text = str_pos_init

    # particle initial ranges
    str_particles = '['
    for robot in robot_list:
        for var in robot.x, robot.y, robot.theta:
            str_particles += str(var-0.05) + ',' + str(var+0.05) + ','
    for var, value in ball.items():
        str_particles += str(value-0.05) + ',' + str(value+0.05) + ','
    str_particles = str_particles[:len(str_particles)-1] + ']'  # last comma becomes ]
    ET.SubElement(launch, 'rosparam', param='CUSTOM_PARTICLE_INIT').text = str_particles

    # path to the new launch file in the pfuclt pkg folder
    path = rospack.get_path('pfuclt_omni_dataset')
    path += '/launch/' + args.file

    # pretty print the tree to the file in the path variable
    with open(path, 'w+') as f:
        f.write(prettify(launch))